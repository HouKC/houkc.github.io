---
layout:     post
title:      DVWA靶机学习——CSP Bypass
subtitle:   这个系列是学习DVWA靶机的。今天学习CSP Bypass，即绕过内容安全策略的Low、Medium、High、Impossible级别。
date:       2020-11-23
author:     HouKC
header-img: img/home-bg-universe.jpg
catalog:    true
tags:
    - CTF
    - web
    - writeup
    - 网络安全
    - dvwa
    - 靶机
---


## 0x00 CSP Bypass
CSP（Content-Security-Policy），即内容安全策略，通俗地说就是开发者告诉客户端，只能执行来自哪里的外部资源，主要是为了缓解XSS和数据注入攻击用的。

开发者可以配置一定的策略，限制客户端浏览器只能执行一定范围内的脚本等资源。

如果设置了CSP但有的浏览器不支持，那浏览器就会直接忽略。

DVWA中的CSP Bypass主要是针对一些开发者对CSP的配置错误，导致攻击者依旧可以绕过防御策略。


## 0x01 Low
#### 源码分析
```php
<?php

$headerCSP = "Content-Security-Policy: script-src 'self' https://pastebin.com  example.com code.jquery.com https://ssl.google-analytics.com ;"; // allows js from self, pastebin.com, jquery and google analytics.

header($headerCSP);

# https://pastebin.com/raw/R570EE00

?>
<?php
if (isset ($_POST['include'])) {
$page[ 'body' ] .= "
    <script src='" . $_POST['include'] . "'></script>
";
}
$page[ 'body' ] .= '
<form name="csp" method="POST">
    <p>You can include scripts from external sources, examine the Content Security Policy and enter a URL to include here:</p>
    <input size="50" type="text" name="include" value="" id="include" />
    <input type="submit" value="Include" />
</form>
```
浏览器看到页面是一个可以输入链接并提交包含。
可以看到源码在HTTP头中设置了CSP，如下：

```
"Content-Security-Policy: script-src 'self' https://pastebin.com  example.com code.jquery.com https://ssl.google-analytics.com ;"
```
这表示只有当前网站、pastebin.com网站、jquery和google analytics这些来源的js脚本才可以执行。

我们可以查下[https://pastebin.com](https://pastebin.com) 网站，发现是一个快捷发步信息的网站，可以写一个alert(1)，然后点击Create New Paste按钮，就会生成并跳转到一个URL，链接返回的页面是我们所填的内容alert(1)。

可以看到源码中会将这个链接用前端script标签加载外部js脚本的方式，去把链接内容包含进来，所以我们将上面在网站https://pastebin.com(https://pastebin.com) 处生成的链接填写到Low级别的CSP Bypass页面输入框里，然后点击include即可弹窗。

#### 解题思路
可以按照上面所分析的步骤：
- 在https://pastebin.com(https://pastebin.com) 网站上生成一个内容为alert(1)的消息。
- 复制生成的链接。
- 在DVWA CSP Bypass输入框中输入，点击Include按钮提交。

**注：理论上如此做是可以弹窗的，但是实验的时候并没有。打开控制台提示”因为 MIME 类型（text/plain）不匹配（X-Content-Type-Options: nosniff）“，查了一下是pastebin.com那个网站返回的HTTP头中设置了X-Content-Type-Options: nosniff，直接限制客户端一定要按照设定的MIME类型（text/plain）去检查，所以现在是弹不了窗了，但原理理解了就好！**


其实源码中还提供了官方做好的信息链接，但我试了也无法弹窗。
```
https://pastebin.com/raw/R570EE00
```



## 0x02 Medium
#### 源码分析
```php
```